<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geotag Camera & Video - MP4 dengan Waktu Custom</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 650px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #4a69bd);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .mode-selector {
            display: flex;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 5px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 8px;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }
        
        .camera-container {
            position: relative;
            background: #000;
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .camera-preview, .video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .recording-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .watermark-overlay {
            position: absolute;
            width: 100%;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            font-size: 14px;
            line-height: 1.5;
            z-index: 10;
        }
        
        .watermark-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .watermark-row:last-child {
            margin-bottom: 0;
        }
        
        .location-info {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .timestamp-info {
            font-weight: bold;
            font-size: 16px;
        }
        
        .coordinate-info {
            font-family: monospace;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            border-color: #4a69bd;
            box-shadow: 0 0 0 2px rgba(74, 105, 189, 0.2);
            outline: none;
        }
        
        .time-controls {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid #ffeaa7;
        }
        
        .time-controls h4 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .time-inputs input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ffd43b;
            border-radius: 5px;
            background: white;
        }
        
        .time-options {
            margin-top: 10px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .time-btn {
            padding: 6px 12px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .time-btn:hover {
            background: #e9ecef;
        }
        
        .time-btn.active {
            background: #4a69bd;
            color: white;
            border-color: #4a69bd;
        }
        
        .coord-manipulation {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .coord-manipulation h4 {
            color: #1565c0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .manipulation-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .manipulation-controls select, .manipulation-controls input {
            width: 100%;
            padding: 8px;
            border: 1px solid #bbdefb;
            border-radius: 5px;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 15px;
        }
        
        .btn-capture {
            background: linear-gradient(135deg, #4a69bd, #2c3e50);
            color: white;
        }
        
        .btn-capture:hover {
            background: linear-gradient(135deg, #3c5aa3, #243342);
            transform: translateY(-2px);
        }
        
        .btn-record {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-record:hover {
            background: linear-gradient(135deg, #d62c1a, #a93226);
            transform: translateY(-2px);
        }
        
        .btn-reset {
            background: #7f8c8d;
            color: white;
        }
        
        .btn-reset:hover {
            background: #616a6b;
            transform: translateY(-2px);
        }
        
        .btn-download {
            background: #27ae60;
            color: white;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-download:hover {
            background: #219a52;
            transform: translateY(-2px);
        }
        
        .btn-upload {
            background: #3498db;
            color: white;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-upload:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .hidden {
            display: none;
        }
        
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .camera-placeholder {
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .camera-icon {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.7;
        }
        
        .placeholder-text {
            font-size: 16px;
            opacity: 0.8;
        }
        
        .video-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .video-time {
            color: white;
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .progress-bar {
            height: 100%;
            background: #4a69bd;
            width: 0%;
            transition: width 0.1s;
        }
        
        @media (max-width: 480px) {
            .camera-container {
                height: 300px;
            }
            
            .input-row, .manipulation-controls, .time-inputs {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .video-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏üé• Geotag Camera & Video</h1>
            <p>Ambil foto dan rekam video dengan timestamp custom, lokasi, dan watermark</p>
            <div class="mode-selector">
                <button class="mode-btn active" id="photoModeBtn" onclick="switchMode('photo')">
                    üì∑ Foto
                </button>
                <button class="mode-btn" id="videoModeBtn" onclick="switchMode('video')">
                    üé• Video
                </button>
            </div>
        </div>
        
        <div class="camera-container">
            <div id="cameraPlaceholder" class="camera-placeholder">
                <div class="camera-icon" id="modeIcon">üì∑</div>
                <div class="placeholder-text" id="modeText">Klik tombol Ambil Foto untuk memulai</div>
            </div>
            <img id="previewImage" class="camera-preview hidden">
            <video id="previewVideo" class="video-preview hidden" controls></video>
            
            <div id="recordingIndicator" class="recording-indicator hidden">
                <div class="rec-dot"></div>
                REC
            </div>
            
            <div id="videoTime" class="video-time hidden">00:00</div>
            
            <div id="watermarkOverlay" class="watermark-overlay hidden">
                <div class="watermark-row">
                    <div class="timestamp-info" id="timestampDisplay">Senin, 01 Jan 2024 12:00:00</div>
                </div>
                <div class="watermark-row">
                    <div class="location-info">
                        <span>üìç</span>
                        <span id="addressDisplay">Jl. Contoh No. 123, Jakarta</span>
                    </div>
                </div>
                <div class="watermark-row">
                    <div class="coordinate-info" id="coordinateDisplay">Lat: -6.2088, Lng: 106.8456</div>
                </div>
            </div>
            
            <div id="progressContainer" class="progress-container hidden">
                <div id="progressBar" class="progress-bar"></div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <h3>üìç Informasi Lokasi</h3>
                <div class="input-row">
                    <div class="input-group">
                        <label for="latitude">Latitude</label>
                        <input type="text" id="latitude" placeholder="-6.2088">
                    </div>
                    <div class="input-group">
                        <label for="longitude">Longitude</label>
                        <input type="text" id="longitude" placeholder="106.8456">
                    </div>
                </div>
                <div class="input-group">
                    <label for="address">Alamat Lengkap</label>
                    <input type="text" id="address" placeholder="Jl. Merdeka No. 123, Jakarta Pusat">
                </div>
                
                <div class="time-controls">
                    <h4>üïê Waktu Watermark</h4>
                    <div class="time-inputs">
                        <div class="input-group">
                            <label for="customDate">Tanggal</label>
                            <input type="date" id="customDate" value="">
                        </div>
                        <div class="input-group">
                            <label for="customTime">Waktu</label>
                            <input type="time" id="customTime" value="12:00">
                        </div>
                    </div>
                    <div class="time-options">
                        <button class="time-btn active" onclick="setTimeOption('now')">Waktu Sekarang</button>
                        <button class="time-btn" onclick="setTimeOption('yesterday')">Kemarin</button>
                        <button class="time-btn" onclick="setTimeOption('tomorrow')">Besok</button>
                        <button class="time-btn" onclick="setTimeOption('custom')">Custom</button>
                    </div>
                </div>
                
                <div class="coord-manipulation">
                    <h4>üîÑ Rekayasa Koordinat</h4>
                    <div class="manipulation-controls">
                        <select id="coordOperation">
                            <option value="none">Tidak ada perubahan</option>
                            <option value="randomize">Acak sedikit (¬±0.001)</option>
                            <option value="offset">Geser koordinat</option>
                            <option value="swap">Tukar Lat/Lng</option>
                            <option value="fake">Koordinat acak di Indonesia</option>
                        </select>
                        <input type="number" id="offsetValue" placeholder="Offset (derajat)" step="0.0001" value="0.001">
                    </div>
                </div>
            </div>
            
            <div class="video-controls" id="videoControls" style="display: none;">
                <div class="input-row">
                    <div class="input-group">
                        <label for="videoDuration">Durasi Video (detik)</label>
                        <input type="number" id="videoDuration" min="1" max="120" value="10">
                    </div>
                    <div class="input-group">
                        <label for="videoFormat">Format Video</label>
                        <select id="videoFormat">
                            <option value="mp4">MP4 (Rekomendasi)</option>
                            <option value="webm">WEBM</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label for="videoQuality">Kualitas Video</label>
                    <select id="videoQuality">
                        <option value="low">Rendah (360p)</option>
                        <option value="medium" selected>Sedang (480p)</option>
                        <option value="high">Tinggi (720p)</option>
                    </select>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn-capture" id="captureBtn" onclick="captureMedia()">
                    üì∑ Ambil Foto
                </button>
                <button class="btn-record hidden" id="recordBtn" onclick="toggleRecording()">
                    ‚è∫Ô∏è Mulai Rekam
                </button>
                <button class="btn-reset" onclick="resetAll()">
                    üîÑ Reset
                </button>
            </div>
            
            <button class="btn-upload" onclick="uploadMedia()" id="uploadBtn">
                ‚¨ÜÔ∏è Upload Media
            </button>
            
            <button class="btn-download" onclick="downloadMedia()" id="downloadBtn" disabled>
                ‚¨áÔ∏è Download Media (MP4)
            </button>
            
            <div id="statusMessage" class="status-message hidden"></div>
        </div>
    </div>

    <!-- Library untuk encode MP4 -->
    <script src="https://unpkg.com/mp4box@0.5.2/dist/mp4box.all.min.js"></script>
    
    <input type="file" id="photoInput" class="hidden" accept="image/*" capture="environment">
    <input type="file" id="videoInput" class="hidden" accept="video/*">
    
    <script>
        // Mode saat ini: 'photo' atau 'video'
        let currentMode = 'photo';
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingTimer = null;
        let recordingStartTime = null;
        let stream = null;
        let currentTimeOption = 'now';
        
        // Data untuk menyimpan media dan lokasi
        let mediaData = {
            originalDataUrl: '',
            watermarkedDataUrl: '',
            location: null,
            hasGeotag: false,
            type: 'photo',
            videoBlob: null,
            customDateTime: new Date() // Default waktu sekarang
        };

        // Format tanggal Indonesia
        function formatIndonesianDate(date) {
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const dayName = days[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            
            return `${dayName}, ${day} ${month} ${year} ${hours}:${minutes}:${seconds}`;
        }

        // Format tanggal untuk input date
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        // Format waktu untuk input time
        function formatTimeForInput(date) {
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        // Fungsi untuk mendapatkan waktu custom
        function getCustomDateTime() {
            const dateInput = document.getElementById('customDate').value;
            const timeInput = document.getElementById('customTime').value;
            
            if (dateInput && timeInput) {
                // Gabungkan tanggal dan waktu
                const dateTimeStr = `${dateInput}T${timeInput}`;
                return new Date(dateTimeStr);
            } else if (dateInput) {
                // Hanya tanggal, gunakan waktu default 12:00
                const dateTimeStr = `${dateInput}T12:00`;
                return new Date(dateTimeStr);
            } else {
                // Kembalikan waktu sekarang
                return new Date();
            }
        }

        // Fungsi untuk set waktu option
        function setTimeOption(option) {
            currentTimeOption = option;
            
            // Update tombol aktif
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const now = new Date();
            
            switch(option) {
                case 'now':
                    // Waktu sekarang
                    mediaData.customDateTime = new Date();
                    document.getElementById('customDate').value = formatDateForInput(now);
                    document.getElementById('customTime').value = formatTimeForInput(now);
                    break;
                    
                case 'yesterday':
                    // Kemarin
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    mediaData.customDateTime = yesterday;
                    document.getElementById('customDate').value = formatDateForInput(yesterday);
                    document.getElementById('customTime').value = formatTimeForInput(yesterday);
                    break;
                    
                case 'tomorrow':
                    // Besok
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    mediaData.customDateTime = tomorrow;
                    document.getElementById('customDate').value = formatDateForInput(tomorrow);
                    document.getElementById('customTime').value = formatTimeForInput(tomorrow);
                    break;
                    
                case 'custom':
                    // Biarkan input custom
                    mediaData.customDateTime = getCustomDateTime();
                    break;
            }
            
            updateWatermark();
        }

        // Fungsi untuk switch mode
        function switchMode(mode) {
            currentMode = mode;
            
            // Update UI mode selector
            document.getElementById('photoModeBtn').classList.remove('active');
            document.getElementById('videoModeBtn').classList.remove('active');
            document.getElementById(mode + 'ModeBtn').classList.add('active');
            
            // Update tombol
            const captureBtn = document.getElementById('captureBtn');
            const recordBtn = document.getElementById('recordBtn');
            const videoControls = document.getElementById('videoControls');
            
            if (mode === 'photo') {
                captureBtn.classList.remove('hidden');
                recordBtn.classList.add('hidden');
                videoControls.style.display = 'none';
                captureBtn.innerHTML = 'üì∑ Ambil Foto';
                document.getElementById('modeIcon').textContent = 'üì∑';
                document.getElementById('modeText').textContent = 'Klik tombol Ambil Foto untuk memulai';
                document.getElementById('downloadBtn').innerHTML = '‚¨áÔ∏è Download Foto (JPG)';
            } else {
                captureBtn.classList.add('hidden');
                recordBtn.classList.remove('hidden');
                videoControls.style.display = 'block';
                document.getElementById('modeIcon').textContent = 'üé•';
                document.getElementById('modeText').textContent = 'Klik tombol Mulai Rekam untuk memulai';
                document.getElementById('downloadBtn').innerHTML = '‚¨áÔ∏è Download Video (MP4)';
            }
            
            // Reset preview jika ada
            resetPreview();
        }

        // Fungsi untuk mengambil foto atau memulai rekaman
        function captureMedia() {
            if (currentMode === 'photo') {
                document.getElementById('photoInput').click();
            }
        }

        // Fungsi untuk toggle recording
        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        // Fungsi untuk mendapatkan resolusi video berdasarkan kualitas
        function getVideoResolution(quality) {
            switch(quality) {
                case 'high':
                    return { width: 1280, height: 720 };
                case 'medium':
                    return { width: 854, height: 480 };
                case 'low':
                    return { width: 640, height: 360 };
                default:
                    return { width: 854, height: 480 };
            }
        }

        // Fungsi untuk memulai rekaman
        async function startRecording() {
            try {
                // Dapatkan format video yang dipilih
                const videoFormat = document.getElementById('videoFormat').value;
                const quality = document.getElementById('videoQuality').value;
                const resolution = getVideoResolution(quality);
                
                // Konfigurasi untuk video
                const constraints = {
                    video: {
                        width: { ideal: resolution.width },
                        height: { ideal: resolution.height },
                        frameRate: { ideal: 30, max: 30 }
                    },
                    audio: true
                };
                
                // Minta akses kamera
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Tampilkan preview video
                const previewVideo = document.getElementById('previewVideo');
                previewVideo.srcObject = stream;
                previewVideo.classList.remove('hidden');
                previewVideo.muted = true;
                previewVideo.play();
                
                // Sembunyikan placeholder
                document.getElementById('cameraPlaceholder').classList.add('hidden');
                
                // Setup MediaRecorder dengan format yang dipilih
                recordedChunks = [];
                const mimeType = videoFormat === 'mp4' 
                    ? 'video/mp4;codecs="avc1.42E01E,mp4a.40.2"' 
                    : 'video/webm;codecs="vp9,opus"';
                
                // Cek apakah format didukung
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    // Fallback ke webm jika mp4 tidak didukung
                    showStatus('‚ö†Ô∏è Format MP4 tidak didukung, menggunakan WEBM sebagai alternatif', 'warning');
                    const fallbackMimeType = 'video/webm;codecs="vp8,opus"';
                    mediaRecorder = new MediaRecorder(stream, { mimeType: fallbackMimeType });
                } else {
                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                }
                
                // Setup event handlers untuk MediaRecorder
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                        
                        // Update progress bar
                        const duration = parseInt(document.getElementById('videoDuration').value);
                        const progress = Math.min((recordedChunks.length / (duration * 10)) * 100, 100);
                        document.getElementById('progressBar').style.width = `${progress}%`;
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const videoBlob = new Blob(recordedChunks, { 
                        type: mediaRecorder.mimeType 
                    });
                    
                    mediaData.videoBlob = videoBlob;
                    mediaData.type = 'video';
                    mediaData.videoFormat = videoFormat;
                    
                    // Tampilkan video yang sudah direkam
                    previewVideo.srcObject = null;
                    previewVideo.src = URL.createObjectURL(videoBlob);
                    previewVideo.controls = true;
                    previewVideo.muted = false;
                    
                    // Tampilkan watermark
                    updateWatermark();
                    document.getElementById('watermarkOverlay').classList.remove('hidden');
                    
                    // Aktifkan tombol download
                    document.getElementById('downloadBtn').disabled = false;
                    
                    showStatus('‚úÖ Video berhasil direkam!', 'success');
                };
                
                // Mulai recording
                const duration = parseInt(document.getElementById('videoDuration').value) * 1000;
                mediaRecorder.start(100); // Ambil data setiap 100ms untuk progress bar
                isRecording = true;
                
                // Update UI
                document.getElementById('recordBtn').innerHTML = '‚èπÔ∏è Stop Rekam';
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordingIndicator').classList.remove('hidden');
                document.getElementById('videoTime').classList.remove('hidden');
                document.getElementById('progressContainer').classList.remove('hidden');
                
                // Timer untuk durasi
                recordingStartTime = Date.now();
                updateRecordingTime();
                
                // Auto stop setelah durasi tertentu
                setTimeout(() => {
                    if (isRecording) {
                        stopRecording();
                    }
                }, duration);
                
                showStatus('‚è∫Ô∏è Sedang merekam video...', 'info');
                
            } catch (error) {
                showStatus('‚ùå Gagal mengakses kamera: ' + error.message, 'error');
            }
        }

        // Fungsi untuk update waktu rekaman
        function updateRecordingTime() {
            if (!isRecording) return;
            
            const elapsed = Date.now() - recordingStartTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const displaySeconds = seconds % 60;
            
            document.getElementById('videoTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
            
            setTimeout(updateRecordingTime, 1000);
        }

        // Fungsi untuk stop recording
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Stop semua track
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                // Update UI
                document.getElementById('recordBtn').innerHTML = '‚è∫Ô∏è Mulai Rekam';
                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('recordingIndicator').classList.add('hidden');
                document.getElementById('videoTime').classList.add('hidden');
                document.getElementById('progressContainer').classList.add('hidden');
                document.getElementById('progressBar').style.width = '0%';
                
                clearTimeout(recordingTimer);
            }
        }

        // Fungsi untuk memproses foto yang diambil
        function processPhoto(input) {
            const file = input.files[0];
            if (!file) return;

            // Validasi ukuran file (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showStatus('‚ùå Ukuran file terlalu besar! Maksimal 10MB.', 'error');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Tampilkan preview
                const preview = document.getElementById('previewImage');
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                
                // Sembunyikan placeholder
                document.getElementById('cameraPlaceholder').classList.add('hidden');
                
                // Simpan foto original
                mediaData.originalDataUrl = e.target.result;
                mediaData.hasGeotag = false;
                mediaData.type = 'photo';
                
                // Update waktu custom
                mediaData.customDateTime = getCustomDateTime();
                
                // Tampilkan watermark dengan data
                updateWatermark();
                document.getElementById('watermarkOverlay').classList.remove('hidden');
                
                // Aktifkan tombol download
                document.getElementById('downloadBtn').disabled = false;
                
                showStatus('‚úÖ Foto berhasil diambil. Isi data lokasi untuk memperbarui watermark.', 'info');
            };
            
            reader.readAsDataURL(file);
        }

        // Fungsi untuk memproses video yang diupload
        function processVideo(input) {
            const file = input.files[0];
            if (!file) return;

            // Validasi ukuran file (max 100MB untuk video)
            if (file.size > 100 * 1024 * 1024) {
                showStatus('‚ùå Ukuran file terlalu besar! Maksimal 100MB.', 'error');
                return;
            }

            // Validasi tipe file
            if (!file.type.startsWith('video/')) {
                showStatus('‚ùå File harus berupa video!', 'error');
                return;
            }

            const videoURL = URL.createObjectURL(file);
            const previewVideo = document.getElementById('previewVideo');
            
            previewVideo.src = videoURL;
            previewVideo.classList.remove('hidden');
            previewVideo.controls = true;
            
            // Sembunyikan placeholder
            document.getElementById('cameraPlaceholder').classList.add('hidden');
            
            // Simpan video
            mediaData.videoBlob = file;
            mediaData.type = 'video';
            mediaData.videoFormat = file.type.includes('mp4') ? 'mp4' : 'webm';
            
            // Update waktu custom
            mediaData.customDateTime = getCustomDateTime();
            
            // Tampilkan watermark
            updateWatermark();
            document.getElementById('watermarkOverlay').classList.remove('hidden');
            
            // Aktifkan tombol download
            document.getElementById('downloadBtn').disabled = false;
            
            showStatus('‚úÖ Video berhasil diupload. Isi data lokasi untuk memperbarui watermark.', 'info');
        }

        // Fungsi untuk rekayasa koordinat
        function manipulateCoordinates(lat, lng) {
            const operation = document.getElementById('coordOperation').value;
            const offset = parseFloat(document.getElementById('offsetValue').value) || 0.001;
            
            let newLat = parseFloat(lat);
            let newLng = parseFloat(lng);
            
            if (isNaN(newLat) || isNaN(newLng)) {
                // Jika koordinat tidak valid, beri nilai default
                newLat = -6.2088;
                newLng = 106.8456;
            }
            
            switch(operation) {
                case 'randomize':
                    // Tambahkan nilai random kecil (¬±0.001)
                    newLat += (Math.random() - 0.5) * 0.002;
                    newLng += (Math.random() - 0.5) * 0.002;
                    break;
                    
                case 'offset':
                    // Geser koordinat dengan offset tertentu
                    newLat += offset;
                    newLng += offset;
                    break;
                    
                case 'swap':
                    // Tukar latitude dan longitude
                    [newLat, newLng] = [newLng, newLat];
                    break;
                    
                case 'fake':
                    // Koordinat acak di Indonesia
                    newLat = -6.2 + (Math.random() - 0.5) * 10;
                    newLng = 106.8 + (Math.random() - 0.5) * 10;
                    break;
                    
                case 'none':
                default:
                    // Tidak ada perubahan
                    break;
            }
            
            // Batasi koordinat ke wilayah Indonesia (sekitar)
            newLat = Math.max(-11, Math.min(6, newLat));
            newLng = Math.max(95, Math.min(141, newLng));
            
            // Format ke 6 desimal
            return {
                lat: newLat.toFixed(6),
                lng: newLng.toFixed(6)
            };
        }

        // Fungsi untuk mengupdate watermark
        function updateWatermark() {
            const timestampDisplay = document.getElementById('timestampDisplay');
            const addressDisplay = document.getElementById('addressDisplay');
            const coordinateDisplay = document.getElementById('coordinateDisplay');
            
            // Update timestamp berdasarkan pilihan waktu
            let displayDate;
            if (currentTimeOption === 'custom') {
                displayDate = getCustomDateTime();
            } else {
                displayDate = mediaData.customDateTime;
            }
            
            timestampDisplay.textContent = formatIndonesianDate(displayDate);
            
            // Ambil data dari form
            let latitude = document.getElementById('latitude').value.trim();
            let longitude = document.getElementById('longitude').value.trim();
            const address = document.getElementById('address').value.trim();
            
            // Terapkan rekayasa koordinat jika ada data
            if (latitude && longitude) {
                const manipulated = manipulateCoordinates(latitude, longitude);
                latitude = manipulated.lat;
                longitude = manipulated.lng;
            }
            
            // Update koordinat
            if (latitude && longitude) {
                coordinateDisplay.textContent = `Lat: ${latitude}, Lng: ${longitude}`;
            } else {
                coordinateDisplay.textContent = 'Lat: -6.2088, Lng: 106.8456';
            }
            
            // Update alamat
            if (address) {
                addressDisplay.textContent = address;
            } else {
                addressDisplay.textContent = 'Jl. Contoh No. 123, Jakarta';
            }
            
            // Simpan data lokasi
            if (latitude && longitude && address) {
                mediaData.location = {
                    lat: parseFloat(latitude),
                    lng: parseFloat(longitude),
                    address: address,
                    timestamp: displayDate.toISOString(),
                    manipulated: document.getElementById('coordOperation').value !== 'none'
                };
                mediaData.hasGeotag = true;
            }
        }

        // Fungsi untuk upload media
        function uploadMedia() {
            if (currentMode === 'photo') {
                document.getElementById('photoInput').click();
            } else {
                document.getElementById('videoInput').click();
            }
        }

        // Fungsi untuk download media dengan watermark
        async function downloadMedia() {
            if (!mediaData.originalDataUrl && !mediaData.videoBlob) {
                showStatus('‚ùå Tidak ada media untuk didownload!', 'error');
                return;
            }

            try {
                if (mediaData.type === 'photo') {
                    await downloadPhotoWithWatermark();
                } else {
                    await downloadVideoWithWatermark();
                }
            } catch (error) {
                showStatus('‚ùå Error mendownload media: ' + error.message, 'error');
                console.error(error);
            }
        }

        // Fungsi untuk download foto dengan watermark
        async function downloadPhotoWithWatermark() {
            const img = new Image();
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size sama dengan foto
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Draw foto asli
                ctx.drawImage(img, 0, 0);
                
                // Tambahkan watermark
                const latitude = document.getElementById('latitude').value.trim() || '-6.2088';
                const longitude = document.getElementById('longitude').value.trim() || '106.8456';
                const address = document.getElementById('address').value.trim() || 'Jl. Contoh No. 123, Jakarta';
                const displayDate = getCustomDateTime();
                
                // Hitung ukuran watermark berdasarkan tinggi foto
                const scaleFactor = canvas.height / 800;
                const fontSize = Math.max(14, 16 * scaleFactor);
                const padding = Math.max(10, 15 * scaleFactor);
                
                // Background watermark
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                const watermarkHeight = padding * 3 + fontSize * 3;
                ctx.fillRect(0, canvas.height - watermarkHeight, canvas.width, watermarkHeight);
                
                // Teks timestamp
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.fillStyle = 'white';
                ctx.fillText(formatIndonesianDate(displayDate), padding, canvas.height - padding * 2 - fontSize * 2);
                
                // Teks alamat
                ctx.font = `${fontSize}px Arial`;
                ctx.fillText(address, padding, canvas.height - padding - fontSize);
                
                // Teks koordinat
                ctx.font = `${fontSize}px monospace`;
                ctx.fillText(`Lat: ${latitude}, Lng: ${longitude}`, padding, canvas.height - padding);
                
                // Konversi ke blob dan download
                canvas.toBlob(function(blob) {
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const fileName = `geotag-photo-${timestamp}.jpg`;
                    
                    // Buat URL untuk download
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showStatus('‚úÖ Foto berhasil didownload dengan watermark!', 'success');
                }, 'image/jpeg', 0.9);
            };
            
            img.src = mediaData.originalDataUrl;
        }

        // Fungsi untuk konversi WebM ke MP4 (menggunakan library MP4Box)
        async function convertWebMToMP4(webmBlob) {
            return new Promise((resolve, reject) => {
                try {
                    // Untuk demo, kita akan return blob asli karena konversi MP4 di browser kompleks
                    // Dalam implementasi nyata, gunakan service worker atau server-side conversion
                    showStatus('‚ö†Ô∏è Konversi ke MP4 memerlukan server. Menggunakan format asli.', 'warning');
                    resolve(webmBlob);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Fungsi untuk download video dengan watermark
        async function downloadVideoWithWatermark() {
            showStatus('‚è≥ Sedang memproses video dengan watermark...', 'info');
            
            // Cek apakah video sudah dalam format MP4
            const videoFormat = mediaData.videoFormat || 'webm';
            let videoBlob = mediaData.videoBlob;
            
            // Jika format webm dan ingin MP4, coba konversi
            if (videoFormat === 'webm' && document.getElementById('videoFormat').value === 'mp4') {
                showStatus('‚è≥ Mengonversi WebM ke MP4...', 'info');
                try {
                    videoBlob = await convertWebMToMP4(videoBlob);
                } catch (error) {
                    showStatus('‚ö†Ô∏è Gagal konversi ke MP4, menggunakan format WebM', 'warning');
                }
            }
            
            // Untuk video, kita akan membuat video baru dengan watermark menggunakan canvas
            const video = document.getElementById('previewVideo');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Tunggu video siap
            await new Promise(resolve => {
                if (video.readyState >= 2) {
                    resolve();
                } else {
                    video.addEventListener('loadedmetadata', resolve);
                }
            });
            
            // Set canvas size sesuai video
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            
            // Buat video element baru untuk output
            const outputStream = canvas.captureStream(30); // 30 fps
            const mimeType = videoFormat === 'mp4' 
                ? 'video/mp4;codecs="avc1.42E01E,mp4a.40.2"' 
                : 'video/webm;codecs="vp9,opus"';
            
            // Cek apakah format didukung
            let recorder;
            if (MediaRecorder.isTypeSupported(mimeType)) {
                recorder = new MediaRecorder(outputStream, { mimeType });
            } else {
                // Fallback ke webm
                recorder = new MediaRecorder(outputStream, { mimeType: 'video/webm;codecs="vp8,opus"' });
            }
            
            const chunks = [];
            
            recorder.ondataavailable = (e) => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: recorder.mimeType });
                
                // Tentukan nama file berdasarkan format
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const format = recorder.mimeType.includes('mp4') ? 'mp4' : 'webm';
                const fileName = `geotag-video-${timestamp}.${format}`;
                
                // Download video
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus(`‚úÖ Video berhasil didownload dengan watermark (${format.toUpperCase()})!`, 'success');
            };
            
            // Mulai rekaman canvas
            recorder.start();
            
            // Fungsi untuk menggambar frame dengan watermark
            function drawFrame() {
                if (video.paused || video.ended) {
                    recorder.stop();
                    return;
                }
                
                try {
                    // Draw video frame
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Tambahkan watermark
                    const latitude = document.getElementById('latitude').value.trim() || '-6.2088';
                    const longitude = document.getElementById('longitude').value.trim() || '106.8456';
                    const address = document.getElementById('address').value.trim() || 'Jl. Contoh No. 123, Jakarta';
                    
                    // Hitung waktu berdasarkan waktu custom + durasi video
                    let displayDate;
                    if (currentTimeOption === 'custom') {
                        displayDate = new Date(getCustomDateTime().getTime() + (video.currentTime * 1000));
                    } else {
                        displayDate = new Date(mediaData.customDateTime.getTime() + (video.currentTime * 1000));
                    }
                    
                    // Hitung ukuran watermark
                    const scaleFactor = canvas.height / 800;
                    const fontSize = Math.max(14, 16 * scaleFactor);
                    const padding = Math.max(10, 15 * scaleFactor);
                    const watermarkHeight = padding * 3 + fontSize * 3;
                    
                    // Background watermark
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.fillRect(0, canvas.height - watermarkHeight, canvas.width, watermarkHeight);
                    
                    // Teks timestamp
                    ctx.font = `bold ${fontSize}px Arial`;
                    ctx.fillStyle = 'white';
                    ctx.fillText(formatIndonesianDate(displayDate), padding, canvas.height - padding * 2 - fontSize * 2);
                    
                    // Teks alamat
                    ctx.font = `${fontSize}px Arial`;
                    ctx.fillText(address, padding, canvas.height - padding - fontSize);
                    
                    // Teks koordinat
                    ctx.font = `${fontSize}px monospace`;
                    ctx.fillText(`Lat: ${latitude}, Lng: ${longitude}`, padding, canvas.height - padding);
                    
                    // Request frame berikutnya
                    requestAnimationFrame(drawFrame);
                } catch (error) {
                    console.error('Error drawing frame:', error);
                    recorder.stop();
                }
            }
            
            // Mulai menggambar
            video.currentTime = 0;
            video.play();
            drawFrame();
            
            // Stop setelah video selesai
            video.onended = () => {
                setTimeout(() => {
                    if (recorder.state === 'recording') {
                        recorder.stop();
                    }
                }, 500);
            };
            
            // Safety timeout
            setTimeout(() => {
                if (recorder.state === 'recording') {
                    recorder.stop();
                }
            }, 300000); // 5 menit timeout
        }

        // Fungsi untuk reset preview
        function resetPreview() {
            // Stop recording jika sedang berlangsung
            if (isRecording) {
                stopRecording();
            }
            
            // Reset preview elements
            document.getElementById('previewImage').classList.add('hidden');
            document.getElementById('previewVideo').classList.add('hidden');
            document.getElementById('previewVideo').src = '';
            document.getElementById('previewVideo').srcObject = null;
            document.getElementById('watermarkOverlay').classList.add('hidden');
            document.getElementById('cameraPlaceholder').classList.remove('hidden');
            document.getElementById('recordingIndicator').classList.add('hidden');
            document.getElementById('videoTime').classList.add('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
            
            // Nonaktifkan tombol download
            document.getElementById('downloadBtn').disabled = true;
        }

        // Fungsi untuk reset semua
        function resetAll() {
            if (confirm('Apakah Anda yakin ingin mereset semua?')) {
                // Reset form
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
                document.getElementById('address').value = '';
                document.getElementById('coordOperation').value = 'none';
                document.getElementById('offsetValue').value = '0.001';
                
                // Reset waktu ke sekarang
                setTimeOption('now');
                
                // Reset preview
                resetPreview();
                
                // Reset data
                mediaData = {
                    originalDataUrl: '',
                    watermarkedDataUrl: '',
                    location: null,
                    hasGeotag: false,
                    type: 'photo',
                    videoBlob: null,
                    customDateTime: new Date()
                };
                
                showStatus('üîÑ Semua data telah direset!', 'info');
                setTimeout(() => {
                    document.getElementById('statusMessage').classList.add('hidden');
                }, 2000);
            }
        }

        // Fungsi untuk menampilkan status
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.classList.remove('hidden');
            
            // Auto hide setelah beberapa detik
            let hideTime = 5000;
            if (type === 'info') hideTime = 5000;
            if (type === 'success') hideTime = 3000;
            if (type === 'warning') hideTime = 7000;
            
            setTimeout(() => {
                if (statusElement.textContent === message) {
                    statusElement.classList.add('hidden');
                }
            }, hideTime);
        }

        // Event listener untuk input file
        document.getElementById('photoInput').addEventListener('change', function() {
            processPhoto(this);
        });
        
        document.getElementById('videoInput').addEventListener('change', function() {
            processVideo(this);
        });

        // Event listener untuk update watermark saat form berubah
        document.getElementById('latitude').addEventListener('input', updateWatermark);
        document.getElementById('longitude').addEventListener('input', updateWatermark);
        document.getElementById('address').addEventListener('input', updateWatermark);
        document.getElementById('coordOperation').addEventListener('change', updateWatermark);
        document.getElementById('offsetValue').addEventListener('input', updateWatermark);
        document.getElementById('customDate').addEventListener('change', function() {
            setTimeOption('custom');
        });
        document.getElementById('customTime').addEventListener('change', function() {
            setTimeOption('custom');
        });

        // Inisialisasi
        document.addEventListener('DOMContentLoaded', function() {
            // Set waktu default ke sekarang
            const now = new Date();
            document.getElementById('customDate').value = formatDateForInput(now);
            document.getElementById('customTime').value = formatTimeForInput(now);
            mediaData.customDateTime = now;
            
            updateWatermark();
        });
    </script>
</body>
</html>
